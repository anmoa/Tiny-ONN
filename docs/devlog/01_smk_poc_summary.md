# DevLog: `smk_poc.py` 的探索与教训

## 引言

本次技术验证的核心目标，是为我们的 `smk_loss` 实现一个理论正确、技术上可行的 `per-token` 协同贡献度 (ΔSC) 计算方案。`ΔSC` 的计算依赖于两个核心矩阵：`per-token, per-expert` 的激活值范数矩阵 `M_A` 和梯度范数矩阵 `M_G`。

激活值 `M_A` 的捕获相对直接，可以在前向传播中轻易获得。然而，`per-token` 梯度 `M_G` 的高效、准确捕获，成为了本次探索的核心技术难点。

## 探索路径回顾

我们经历了一个漫长而曲折的探索过程，其中充满了试错、反思和对 PyTorch 底层机制的深入挖掘。

### 方案 V1: 朴素 `hook`

我们最初的直觉是使用 `torch.Tensor.register_hook`。我们期望在 `main_loss.backward()` 期间，通过 `hook` 拦截到每个专家输出张量上的梯度。

- **失败原因**: PoC (`grad_capture_poc.py`) 证明，`hook` 捕获的是**整个批次**损失对专家输出的**聚合梯度**，无法分离出每个 `token` 的独立贡献。

### 方案 V2: `functorch.vmap`

在 `DeepWiki` 的指引下，我们转向了 `functorch.vmap`，这是 PyTorch 官方推荐的 `per-sample` 梯度计算范式。

- **遇到的挑战**:
  1. **性能与显存**: `vmap` 对整个模型进行向量化，导致了巨大的性能开销和显存消耗，超出了我们 8GB 的硬件限制。
  2. **动态形状**: `vmap` 不支持 `nonzero`、`if tensor.any()` 等数据依赖的控制流和动态形状操作，这迫使我们对 MoE 的稀疏路由逻辑进行“稠密化”改造，进一步增加了计算负担。

### 方案 V3: 原生 `autograd.grad` 与单位矩阵

我们进一步探索了 `torch.autograd.grad` 的底层机制，试图通过构造一个单位矩阵作为 `grad_outputs` 来一次性计算出完整的 Jacobian 矩阵。

- **失败原因**: `autograd.grad` 的 `grad_outputs` 参数执行的是 Jacobian-vector product，而非 Jacobian-matrix product。它期望 `grad_outputs` 与 `outputs` 具有完全相同的形状，因此无法通过传入一个二维的单位矩阵来处理一维的 `loss_per_token` 张量。

### 方案 V4: 性能妥协 (`per-expert` 梯度)

在 `vmap` 的性能瓶颈和原生 `autograd` 的机制限制下，我们尝试了一个务实的妥协方案：`M_A` 保持 `per-token`，而 `M_G` 则在 `per-expert` 的粒度上进行近似（即，将整个批次对某个专家的总梯度范数，赋给所有路由到该专家的 `token`）。

- **失败原因**: 实验结果表明，这种近似无法为门控网络提供有意义的学习信号。`g_acc` 始终为 1.0，`kl_div` 接近于 0，模型陷入平凡解，只会生成无意义的重复字符或模板头。

## 最终结论

经过 exhaustive 的探索，我们得出以下结论：

1. **理论正确性**: 在当前的 PyTorch 框架下，`functorch.vmap` 是**唯一**经过我们 PoC 验证的、能够实现**理论正确**的 `per-token` 梯度计算的方法。
2. **性能代价**: `vmap` 的巨大性能和显存开销是不可避免的。这并非 `vmap` 本身的缺陷，而是 `per-token` 梯度计算这个任务内在的复杂性所决定的。
3. **问题归因**: `smk_poc.py` 中模型表现不佳的根本原因，很可能**不是** `smk_loss` 理论的失败，而是**模型尺寸过小**和**数据量严重不足**的共同作用，导致模型在学会任何有意义的语言模式之前，就过早地收敛到了一个平凡的局部最优解。

## 下一步

我们必须接受 `vmap` 是当前唯一的正确道路。下一步的工作重心，将是从 `exp` 阶段转向真正的项目重构，我们需要：

1. **重构训练框架**: 设计一个能够有效管理显存、支持长时间、大规模 `vmap` 训练的稳定框架。
2. **扩大模型与数据**: 在新的框架下，我们将能够测试更大尺寸的模型（例如 0.1B 级别）和更大规模的数据集（例如 2.5M tokens），以期为 `smk_loss` 提供一个能够真正发挥其作用的、公平的实验环境。
