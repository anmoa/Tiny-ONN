# 关于剪枝模型推理乱码问题的深度复盘

## 现象

在重构剪枝逻辑后，即使在 FP16 精度下，模型推理也会输出乱码。这与旧版 `commit 8309a66` 的行为不符，旧版剪枝模型可以正常推理。

## 核心谜题

为什么旧版的剪枝可行，而新版的实现会导致乱码？我们在重构中丢失了什么？

## 分析与澄清

通过对比新旧两个版本的 `PrunedQwen3DecoderLayer` 实现，我们找到了问题的根源。

### 旧版实现 (Commit `8309a66`)

- **`__init__`**: `super().__init__(config, layer_idx)` 这一行会创建一个**结构上完整**的标准 `Qwen3DecoderLayer`。所有的子模块（包括 `self_attn` 和 `mlp`）都被完整地创建和初始化了。
- **`forward`**: 通过布尔标志（`if self.prune_self_attn:`）在**计算流**中跳过对特定模块的调用。当跳过时，代码直接 `pass`，依赖外部的残差连接 `hidden_states = residual + ...` 来传递信息流。

**结论**：旧版实现保留了模型的**物理结构完整性**，仅在功能上（计算图层面）实现了剪枝。这确保了与 `transformers` 框架的完全兼容性。

### 新版实现 (重构后)

- **`__init__`**: 为了追求所谓的“代码整洁”，我用 `nn.Identity()` **物理上替换**了被剪枝的模块。
- **`forward`**: 通过 `isinstance(..., nn.Identity)` 来判断是否为剪枝模块。

**结论**：新版实现破坏了模型的**物理结构完整性**。这种结构上的残缺导致了与 `transformers` 框架底层机制的冲突：

1. **结构不兼容**：`from_pretrained` 在加载时，面对一个它不认识的、被“挖空”的结构，其内部关于设备映射、量化等流程的假设被破坏。
2. **权重不匹配**：`save_pretrained` 保存的是这个残缺结构的信息。加载时，`transformers` 会因为模型骨架与 `state_dict` 中的权重列表不匹配而抛出 `Some weights ... were not initialized` 的警告，并可能引发未知的副作用，最终导致推理结果错误（乱码）。

我们丢失的关键是对 `transformers` 框架所期望的**模型结构一致性**的尊重。

## 最终行动计划：回归并超越

我们必须回归 `8309a66` 的核心思想，并将其完善，以确保模型结构的兼容性和剪枝的有效性。

1. **第一步：修正 `models/pruned_layers.py`**
    - 修改 `PrunedQwen3DecoderLayer` 的 `__init__` 方法，使其像旧版一样，先创建完整的父类，保留所有子模块的物理存在。
    - `forward` 方法将严格使用布尔标志来跳过计算，确保正确的残差连接逻辑。

2. **第二步：修正剪枝脚本 `scripts/PI_Pruning.py`**
    - 该脚本的核心任务将从“替换模型层”转变为“**对权重进行剪枝**”。
    - 它会加载一个完整的模型，然后遍历其 `state_dict`。
    - 根据 `PrunedQwen3DecoderLayer` 中定义的布尔标志，从 `state_dict` 中**删除**掉被剪枝模块对应的权重条目。
    - 最后，它将这个“瘦身”后的 `state_dict` 和未经修改的 `config.json` 一起保存到新的目录。这才是真正的“剪枝”——既减小了文件大小，又能在加载时与一个完整的模型骨架兼容。

3. **第三步：修正加载脚本 `scripts/fMRI.py`**
    - 加载时，脚本会先使用 `trust_remote_code=True` 创建一个**结构完整**的 `PrunedQwen3ForCausalLM` 模型骨架。
    - 然后，使用 `load_state_dict(strict=False)` 加载我们“瘦身”过的权重。`strict=False` 在这里至关重要，因为它允许模型骨架中存在、而 `state_dict` 中不存在的键（即被我们剪掉的权重），这些权重将保留其随机初始化的值，但由于 `forward` 逻辑会跳过它们，所以不会影响最终计算结果。
    - 最后再按需应用量化。

这个方案结合了两个版本的优点：既保持了与 `transformers` 框架的兼容性，又实现了减小磁盘占用和跳过计算的剪枝目标，能够从根本上解决问题。
